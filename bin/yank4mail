# last modified 2021-12-20
# created < 2018-08-07
# Dorai Sitaram

if test ! "$DISPLAY"; then
  exit
fi

if which xclip | grep -q .; then
  true
else
  echo Needs xclip installed; exit
fi

if test $# -ne 1; then
  echo Need one file arg; exit
fi

tmpf=~/tmp/.tmp.$$

cp -p $1 $tmpf

echo '

"trailing space implies paragraph continues to next line
set fo+=w

"remove all trailing spaces
sil! %s/\s\+$//

"add one trailing space for line starting with non-blank
g/^\S/ s/\S$/\0 /

"remove trailing space on last line of paragraph
g/^$/ -1s/\s\+$//

"at every non-blank line, reformat up to paragraph end

"if vi has text objects
"g/\s$/ norm vipJ

"if unsure
g/\s$/ norm }{e0v}b$J

sil! %s/\s\+$//

w

' | vi -es $tmpf

xclip -selection clipboard -i $tmpf

rm $tmpf
