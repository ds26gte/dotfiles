# last modified 2014-11-22

if test $# -ne 2
then echo need 2 args; exit
fi

if test ! -f $1
then echo file $1 not found; exit
fi

if test -d $2
then echo second arg $2 is a directory; exit
fi

cp -p $1 $2

ex -u NONE $2 <<EOF

func! SubAlternate(...)
  if !exists('b:subAlternateP')
    let b:subAlternateP = 1
  endif
  if a:0
    let b:subAlternateP = 1
  else
    let b:subAlternateP = !b:subAlternateP
    return b:subAlternateP
  endif
endfunc

"save all verbatim Þs, as we'll be using Þ to help in the
"conversion

%s/Þ/&tzpThornTzp/g

"mark all lines of code display as we don't want to change stuff
"in there

%s/^\s*\(\`\`\`\)/ÞtzpCodeDisplayTzp\1/

call SubAlternate(0)

g/^ÞtzpCodeDisplayTzp/ s/^ÞtzpCodeDisplayTzp/\=(submatch(0) . SubAlternate())

g/^ÞtzpCodeDisplayTzp0/, /^ÞtzpCodeDisplayTzp1/ s/^/ÞtzpPreformattedTzp/

%s/^\(ÞtzpPreformattedTzp\)ÞtzpCodeDisplayTzp[01]/\1/

"in-text †id is a call to footnote

v/^ÞtzpPreformattedTzp/ s/\(.\)†\(\S\+\%([:punct:]\)\@<!\)/\1[^\2]/g

"line-final ‡ ends footnote text

v/^ÞtzpPreformattedTzp/ s/\(.\)\(‡\)\s*\$/\1\rÞtzpFootnoteEndTzp/

"line-beginning † starts a footnote text

%s/^†\s*\(\S\+\%([:punct:]\)\@<!\)/ÞtzpFootnoteStartTzp[^\1]:./

"blank line within footnote text becomes ¶

g/^ÞtzpFootnoteStartTzp/, /^ÞtzpFootnoteEndTzp/ s/^\$/¶/

"g/^ÞtzpFootnoteStartTzp/, /^ÞtzpFootnoteEndTzp/ s/^\$/ÞtzpFootnoteGrafTzp/

"g/^ÞtzpFootnoteGrafTzp/+1 s/^/ÞtzpFootnoteNextGrafTzp   /

"for every line with leading space, mark it all subsequent lines
"until a blank line exclusive. Call these leading-space
"blocks

g/^\s/, /^\s*\$/ s/^/ÞtzpLeadingSpaceLineTzp/

%s/^ÞtzpLeadingSpaceTzp\s*\$//

"%s/^•\(\s\)/*\1/

"a line with no leading space in a leading-space block is marked
"as a continuation line

%s/^ÞtzpLeadingSpaceLineTzp\(\S\)/ÞtzpLeadingSpaceContinuationLineTzp\1/

"attach continuation lines to their main line

while 1
  let b:continuationLinesLeft = 0
  g/^ÞtzpLeadingSpaceContinuationLineTzp/ let b:continuationLinesLeft = 1
  if b:continuationLinesLeft
    g/^ÞtzpLeadingSpaceContinuationLineTzp/ -1,. j
  else
    break
  endif
endwhile

%s/ÞtzpLeadingSpaceContinuationLineTzp//g

"add trailing spaces to the leading-space lines

%s/^ÞtzpLeadingSpaceLineTzp\(.*\)/\1  /

"remove all footnote line markings

%s/^ÞtzpFootnote\S\{-}Tzp//

"remove all code display line markings

%s/^ÞtzpPreformattedTzp//

"restore verbatim Þs

%s/\(Þ\)tzpThornTzp/\1/g

w
EOF
